"""
HITRAN CRDS ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ - ÌòºÌï© Í∞ÄÏä§ Î∂ÑÏÑù + Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Session State)
"""

import streamlit as st
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import sys
import os
import io
sys.path.append(os.path.dirname(os.path.dirname(__file__)))

from data_handler.hitran_api import HitranAPI
from spectrum_calc.absorption import SpectrumCalculator

# ÌéòÏù¥ÏßÄ ÏÑ§Ï†ï
st.set_page_config(
    page_title="HITRAN CRDS Simulator",
    page_icon="üåü",
    layout="wide"
)

# Session State Ï¥àÍ∏∞Ìôî
if 'calculation_results' not in st.session_state:
    st.session_state.calculation_results = None
if 'calculation_params' not in st.session_state:
    st.session_state.calculation_params = None

# Ï†úÎ™©
st.title("üåü HITRAN CRDS Spectrum Simulator")
st.markdown("**ÌòºÌï© Í∞ÄÏä§ Ïä§ÌéôÌä∏Îüº ÏãúÎÆ¨Î†àÏù¥ÏÖò ÎèÑÍµ¨**")

# ÏÇ¨Ïù¥ÎìúÎ∞î - ÌååÎùºÎØ∏ÌÑ∞ ÏÑ§Ï†ï
st.sidebar.header("üìä ÏãúÎÆ¨Î†àÏù¥ÏÖò ÌååÎùºÎØ∏ÌÑ∞")

# Î∂ÑÏûê Îã§Ï§ë ÏÑ†ÌÉù
available_molecules = ["H2O", "CO2", "CH4", "NH3", "N2O", "CO", "O3", "SO2", "NO2", "HNO3"]
selected_molecules = st.sidebar.multiselect(
    "Î∂ÑÏûê ÏÑ†ÌÉù (ÏµúÎåÄ 10Í∞ú)",
    available_molecules,
    default=["H2O"],
    max_selections=10
)

# ÌååÏû• Î≤îÏúÑ
st.sidebar.subheader("ÌååÏû• Î≤îÏúÑ (nm)")
col1, col2 = st.sidebar.columns(2)
with col1:
    wavelength_min = st.number_input("ÏµúÏÜå", value=1500, min_value=100, max_value=10000, step=1)
with col2:
    wavelength_max = st.number_input("ÏµúÎåÄ", value=1520, min_value=100, max_value=10000, step=1)

# Î¨ºÎ¶¨ Ï°∞Í±¥
st.sidebar.subheader("Î¨ºÎ¶¨ Ï°∞Í±¥")

# Ïò®ÎèÑ (K)
temperature = st.sidebar.number_input(
    "Ïò®ÎèÑ (K)", 
    value=296.15, 
    min_value=200.0, 
    max_value=400.0, 
    step=0.1,
    format="%.2f"
)

# ÏïïÎ†• (torr)
pressure_torr = st.sidebar.number_input(
    "ÏïïÎ†• (torr)", 
    value=5320.0,
    min_value=1.0, 
    max_value=15000.0, 
    step=1.0,
    format="%.1f"
)

# Í≤ΩÎ°ú Í∏∏Ïù¥ (m)
path_length_m = st.sidebar.number_input(
    "Í≤ΩÎ°ú Í∏∏Ïù¥ (m)", 
    value=30000.0,
    min_value=1.0, 
    max_value=50000.0, 
    step=1.0,
    format="%.0f"
)

# Î∂ÑÏûêÎ≥Ñ ÎÜçÎèÑ ÏÑ§Ï†ï
if selected_molecules:
    st.sidebar.subheader("üß™ Î∂ÑÏûêÎ≥Ñ ÎÜçÎèÑ (ppb)")
    molecule_concentrations = {}
    
    for molecule in selected_molecules:
        concentration = st.sidebar.number_input(
            f"{molecule} (ppb)",
            value=1000.0 if molecule == "H2O" else 400.0,
            min_value=0.1,
            max_value=10000000.0,
            step=0.1,
            format="%.1f",
            key=f"conc_{molecule}"
        )
        molecule_concentrations[molecule] = concentration

# Í≥ÑÏÇ∞ Î≤ÑÌäº
calculate_button = st.sidebar.button("üßÆ ÌòºÌï© Ïä§ÌéôÌä∏Îüº Í≥ÑÏÇ∞", type="primary")

# Í≤∞Í≥º Ï¥àÍ∏∞Ìôî Î≤ÑÌäº
if st.session_state.calculation_results is not None:
    clear_button = st.sidebar.button("üóëÔ∏è Í≤∞Í≥º Ï¥àÍ∏∞Ìôî", type="secondary")
    if clear_button:
        st.session_state.calculation_results = None
        st.session_state.calculation_params = None
        st.rerun()

# Îã®ÏúÑ Î≥ÄÌôò
pressure_atm = pressure_torr / 760.0
path_length_km = path_length_m / 1000.0

# Î∂ÑÏûêÎ≥Ñ Ï∂îÏ≤ú ÌååÏû• Î≤îÏúÑ Ï†ïÎ≥¥
wavelength_ranges = {
    "H2O": "1350-1950nm, 2500-3000nm",
    "CO2": "2000-2100nm, 4200-4400nm",
    "CH4": "1600-1700nm, 3200-3400nm",
    "NH3": "1500-1600nm, 3000-3100nm",
    "N2O": "2200-2300nm, 4400-4600nm",
    "CO": "2300-2400nm, 4600-4800nm",
    "O3": "9600-10000nm",
    "SO2": "7300-7500nm, 8600-8800nm",
    "NO2": "6200-6300nm",
    "HNO3": "1300-1400nm, 7500-7600nm"
}

# Î©îÏù∏ ÌôîÎ©¥
col1, col2 = st.columns([2, 1])

with col2:
    st.subheader("üìã ÌòÑÏû¨ ÏÑ§Ï†ï")
    st.write(f"**ÏÑ†ÌÉùÎêú Î∂ÑÏûê:** {', '.join(selected_molecules) if selected_molecules else 'ÏóÜÏùå'}")
    st.write(f"**Ïò®ÎèÑ:** {temperature} K ({temperature-273.15:.1f}¬∞C)")
    st.write(f"**ÏïïÎ†•:** {pressure_torr:.1f} torr ({pressure_atm:.2f} atm)")
    st.write(f"**Í≤ΩÎ°ú Í∏∏Ïù¥:** {path_length_m:.0f} m ({path_length_km:.1f} km)")
    st.write(f"**ÌååÏû• Î≤îÏúÑ:** {wavelength_min}-{wavelength_max} nm")
    
    # Î∂ÑÏûêÎ≥Ñ ÎÜçÎèÑ ÌëúÏãú
    if selected_molecules:
        st.subheader("üß™ Î∂ÑÏûêÎ≥Ñ ÎÜçÎèÑ")
        for molecule in selected_molecules:
            conc_ppb = molecule_concentrations.get(molecule, 0)
            conc_ppm = conc_ppb / 1000.0
            st.write(f"**{molecule}:** {conc_ppb:.1f} ppb ({conc_ppm:.3f} ppm)")
    
    # ÌòºÌï© Í∞ÄÏä§ Ï¥ù ÎÜçÎèÑ
    if selected_molecules:
        total_ppb = sum(molecule_concentrations.values())
        st.write(f"**Ï¥ù ÎÜçÎèÑ:** {total_ppb:.1f} ppb ({total_ppb/1000:.3f} ppm)")
    
    # Ï∂îÏ≤ú ÌååÏû• Î≤îÏúÑ
    if selected_molecules:
        st.subheader("üí° Ï∂îÏ≤ú ÌååÏû• Î≤îÏúÑ")
        for molecule in selected_molecules:
            st.info(f"**{molecule}:** {wavelength_ranges.get(molecule, 'Ï†ïÎ≥¥ ÏóÜÏùå')}")

# Í≥ÑÏÇ∞ Ïã§Ìñâ
with col1:
    if calculate_button and selected_molecules:
        if wavelength_min >= wavelength_max:
            st.error("‚ùå ÏµúÏÜå ÌååÏû•Ïù¥ ÏµúÎåÄ ÌååÏû•Î≥¥Îã§ ÏûëÏïÑÏïº Ìï©ÎãàÎã§!")
        else:
            # ÏßÑÌñâ ÌëúÏãú
            progress_bar = st.progress(0)
            status_text = st.empty()
            
            try:
                # Ï£ºÌååÏàò Í≤©Ïûê ÏÉùÏÑ±
                freq_min = 1e7 / wavelength_max
                freq_max = 1e7 / wavelength_min
                frequency_grid = np.linspace(freq_min, freq_max, 5000)
                
                # Í∞Å Î∂ÑÏûêÎ≥Ñ Ïä§ÌéôÌä∏Îüº Í≥ÑÏÇ∞
                hitran_api = HitranAPI()
                calc = SpectrumCalculator()
                
                individual_spectra = {}
                combined_absorption = np.zeros_like(frequency_grid)
                
                for i, molecule in enumerate(selected_molecules):
                    progress = int(20 + (i / len(selected_molecules)) * 60)
                    status_text.text(f"üì• {molecule} Îç∞Ïù¥ÌÑ∞ Îã§Ïö¥Î°úÎìú Ï§ë... ({i+1}/{len(selected_molecules)})")
                    progress_bar.progress(progress)
                    
                    # HITRAN Îç∞Ïù¥ÌÑ∞ Îã§Ïö¥Î°úÎìú
                    hitran_data = hitran_api.download_molecule_data(molecule, wavelength_min, wavelength_max)
                    
                    if hitran_data is not None and len(hitran_data) > 0:
                        # Í∞úÎ≥Ñ Ïä§ÌéôÌä∏Îüº Í≥ÑÏÇ∞
                        concentration = molecule_concentrations[molecule] / 1e9  # ppb to Î™∞Î∂ÑÏú®
                        
                        spectrum = calc.calculate_absorption_spectrum(
                            hitran_data=hitran_data,
                            frequency_grid=frequency_grid,
                            temperature=temperature,
                            pressure=pressure_atm,
                            concentration=concentration,
                            path_length=path_length_m,
                            molecule=molecule
                        )
                        
                        individual_spectra[molecule] = spectrum
                        combined_absorption += spectrum['absorption_coeff']
                    else:
                        st.warning(f"‚ö†Ô∏è {molecule} Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§ (ÌååÏû• Î≤îÏúÑ: {wavelength_min}-{wavelength_max}nm)")
                
                # ÌòºÌï© Ïä§ÌéôÌä∏Îüº Í≥ÑÏÇ∞
                status_text.text("üßÆ ÌòºÌï© Ïä§ÌéôÌä∏Îüº Í≥ÑÏÇ∞ Ï§ë...")
                progress_bar.progress(80)
                
                combined_transmittance = np.exp(-combined_absorption * path_length_m)
                combined_absorbance = -np.log10(combined_transmittance)
                wavelength_nm = 1e7 / frequency_grid
                
                # Î∂ÑÏûêÎ≥Ñ Í∏∞Ïó¨ÎèÑ Í≥ÑÏÇ∞
                contribution_data = []
                for molecule, spectrum in individual_spectra.items():
                    max_abs = np.max(spectrum['absorbance'])
                    contribution_data.append({
                        'Î∂ÑÏûê': molecule,
                        'ÏµúÎåÄ Ìù°Í¥ëÎèÑ': f"{max_abs:.4f}",
                        'ÎÜçÎèÑ (ppb)': f"{molecule_concentrations[molecule]:.1f}",
                        'Í∏∞Ïó¨Ïú®': f"{(max_abs / np.max(combined_absorbance) * 100):.1f}%" if np.max(combined_absorbance) > 0 else "0%"
                    })
                
                # Session StateÏóê Í≤∞Í≥º Ï†ÄÏû•
                st.session_state.calculation_results = {
                    'individual_spectra': individual_spectra,
                    'combined_transmittance': combined_transmittance,
                    'combined_absorbance': combined_absorbance,
                    'wavelength_nm': wavelength_nm,
                    'combined_absorption': combined_absorption,
                    'contribution_data': contribution_data,
                    'total_lines': sum(len(hitran_api.download_molecule_data(mol, wavelength_min, wavelength_max) or []) for mol in selected_molecules)
                }
                
                # ÌååÎùºÎØ∏ÌÑ∞ÎèÑ Ï†ÄÏû•
                st.session_state.calculation_params = {
                    'selected_molecules': selected_molecules.copy(),
                    'wavelength_min': wavelength_min,
                    'wavelength_max': wavelength_max,
                    'temperature': temperature,
                    'pressure_torr': pressure_torr,
                    'pressure_atm': pressure_atm,
                    'path_length_m': path_length_m,
                    'path_length_km': path_length_km,
                    'molecule_concentrations': molecule_concentrations.copy()
                }
                
                progress_bar.progress(100)
                status_text.text("‚úÖ ÌòºÌï© Ïä§ÌéôÌä∏Îüº Í≥ÑÏÇ∞ ÏôÑÎ£å!")
                
            except Exception as e:
                st.error(f"‚ùå ÏóêÎü¨ Î∞úÏÉù: {str(e)}")
                progress_bar.empty()
                status_text.empty()
    
    elif calculate_button and not selected_molecules:
        st.warning("‚ö†Ô∏è Î∂ÑÏÑùÌï† Î∂ÑÏûêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!")

# Ï†ÄÏû•Îêú Í≤∞Í≥º ÌëúÏãú
if st.session_state.calculation_results is not None:
    results = st.session_state.calculation_results
    params = st.session_state.calculation_params
    
    with col1:
        # Í∑∏ÎûòÌîÑ ÏÉùÏÑ±
        st.subheader("üìä Ïä§ÌéôÌä∏Îüº Í≤∞Í≥º")
        
        # ÏÉâÏÉÅ ÌåîÎ†àÌä∏
        colors = ['blue', 'red', 'green', 'orange', 'purple', 'brown', 'pink', 'gray', 'olive', 'cyan']
        
        # Plotly Í∑∏ÎûòÌîÑ ÏÉùÏÑ±
        fig = make_subplots(
            rows=3, cols=1,
            subplot_titles=('Í∞úÎ≥Ñ Î∂ÑÏûê Ìù°Í¥ëÎèÑ', 'ÌòºÌï© Ìà¨Í≥ºÏú®', 'ÌòºÌï© Ìù°Í¥ëÎèÑ'),
            vertical_spacing=0.08
        )
        
        # 1. Í∞úÎ≥Ñ Î∂ÑÏûê Ìù°Í¥ëÎèÑ
        for i, (molecule, spectrum) in enumerate(results['individual_spectra'].items()):
            fig.add_trace(
                go.Scatter(
                    x=results['wavelength_nm'],
                    y=spectrum['absorbance'],
                    mode='lines',
                    name=f'{molecule}',
                    line=dict(color=colors[i % len(colors)], width=1)
                ),
                row=1, col=1
            )
        
        # 2. ÌòºÌï© Ìà¨Í≥ºÏú®
        fig.add_trace(
            go.Scatter(
                x=results['wavelength_nm'],
                y=results['combined_transmittance'],
                mode='lines',
                name='ÌòºÌï© Ìà¨Í≥ºÏú®',
                line=dict(color='black', width=2)
            ),
            row=2, col=1
        )
        
        # 3. ÌòºÌï© Ìù°Í¥ëÎèÑ
        fig.add_trace(
            go.Scatter(
                x=results['wavelength_nm'],
                y=results['combined_absorbance'],
                mode='lines',
                name='ÌòºÌï© Ìù°Í¥ëÎèÑ',
                line=dict(color='darkred', width=2)
            ),
            row=3, col=1
        )
        
        # Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï
        fig.update_layout(
            height=900,
            title=f"ÌòºÌï© Í∞ÄÏä§ Ïä§ÌéôÌä∏Îüº ({', '.join(params['selected_molecules'])})",
            showlegend=True
        )
        
        fig.update_xaxes(title_text="ÌååÏû• (nm)", row=3, col=1)
        fig.update_yaxes(title_text="Ìù°Í¥ëÎèÑ", row=1, col=1)
        fig.update_yaxes(title_text="Ìà¨Í≥ºÏú®", row=2, col=1)
        fig.update_yaxes(title_text="Ìù°Í¥ëÎèÑ", row=3, col=1)
        
        # Í∑∏ÎûòÌîÑ ÌëúÏãú
        st.plotly_chart(fig, use_container_width=True)
        
        # Í≤∞Í≥º Î∂ÑÏÑù
        st.subheader("üìà Î∂ÑÏÑù Í≤∞Í≥º")
        
        col_a, col_b, col_c = st.columns(3)
        
        with col_a:
            st.metric("Ï¥ù HITRAN ÎùºÏù∏ Ïàò", f"{results['total_lines']:,}")
        
        with col_b:
            st.metric("ÏµúÏÜå Ìà¨Í≥ºÏú®", f"{np.min(results['combined_transmittance']):.4f}")
        
        with col_c:
            st.metric("ÏµúÎåÄ Ìù°Í¥ëÎèÑ", f"{np.max(results['combined_absorbance']):.4f}")
        
        # Î∂ÑÏûêÎ≥Ñ Í∏∞Ïó¨ÎèÑ
        st.subheader("üîç Î∂ÑÏûêÎ≥Ñ Í∏∞Ïó¨ÎèÑ")
        df = pd.DataFrame(results['contribution_data'])
        st.dataframe(df, use_container_width=True)
        
        # Ïä§ÌéôÌä∏Îüº Í∞ÑÏÑ≠ Î∂ÑÏÑù
        if len(results['individual_spectra']) > 1:
            st.subheader("‚ö†Ô∏è Ïä§ÌéôÌä∏Îüº Í∞ÑÏÑ≠ Î∂ÑÏÑù")
            overlap_threshold = 0.01
            
            overlap_regions = []
            for i in range(len(results['wavelength_nm'])):
                overlapping_molecules = []
                for molecule, spectrum in results['individual_spectra'].items():
                    if spectrum['absorbance'][i] > overlap_threshold:
                        overlapping_molecules.append(molecule)
                
                if len(overlapping_molecules) > 1:
                    overlap_regions.append({
                        'ÌååÏû• (nm)': f"{results['wavelength_nm'][i]:.1f}",
                        'Í∞ÑÏÑ≠ Î∂ÑÏûê': ', '.join(overlapping_molecules),
                        'Í∞ÑÏÑ≠ Í∞ïÎèÑ': 'High' if len(overlapping_molecules) > 2 else 'Medium'
                    })
            
            if overlap_regions:
                unique_overlaps = {}
                for region in overlap_regions:
                    key = region['Í∞ÑÏÑ≠ Î∂ÑÏûê']
                    if key not in unique_overlaps:
                        unique_overlaps[key] = region
                
                st.warning(f"üîç {len(unique_overlaps)}Í∞úÏùò Ïä§ÌéôÌä∏Îüº Í∞ÑÏÑ≠ ÏòÅÏó≠Ïù¥ Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.")
                overlap_df = pd.DataFrame(list(unique_overlaps.values()))
                st.dataframe(overlap_df, use_container_width=True)
            else:
                st.success("‚úÖ ÏÑ†ÌÉùÌïú ÌååÏû• Î≤îÏúÑÏóêÏÑú Ïã¨Í∞ÅÌïú Ïä§ÌéôÌä∏Îüº Í∞ÑÏÑ≠Ïù¥ Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.")
        
        # Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏÑπÏÖò
        st.subheader("üìÅ Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞")
        
        col_download1, col_download2, col_download3, col_download4 = st.columns(4)
        
        with col_download1:
            # Ïä§ÌéôÌä∏Îüº Îç∞Ïù¥ÌÑ∞ CSV
            spectrum_data = {
                'Wavelength_nm': results['wavelength_nm'],
                'Combined_Transmittance': results['combined_transmittance'],
                'Combined_Absorbance': results['combined_absorbance']
            }
            
            # Í∞úÎ≥Ñ Î∂ÑÏûê Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
            for molecule, spectrum in results['individual_spectra'].items():
                spectrum_data[f'{molecule}_Transmittance'] = spectrum['transmittance']
                spectrum_data[f'{molecule}_Absorbance'] = spectrum['absorbance']
            
            spectrum_df = pd.DataFrame(spectrum_data)
            csv_data = spectrum_df.to_csv(index=False)
            
            st.download_button(
                label="üìä Ïä§ÌéôÌä∏Îüº Îç∞Ïù¥ÌÑ∞ (CSV)",
                data=csv_data,
                file_name=f"spectrum_data_{'-'.join(params['selected_molecules'])}_{params['wavelength_min']}-{params['wavelength_max']}nm.csv",
                mime="text/csv"
            )
        
        with col_download2:
            # Í≥ÑÏÇ∞ Ï°∞Í±¥ ÏöîÏïΩ
            summary_text = f"""HITRAN CRDS ÏãúÎÆ¨Î†àÏù¥ÏÖò Í≤∞Í≥º ÏöîÏïΩ
=================================

Í≥ÑÏÇ∞ ÏùºÏãú: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S')}

Î∂ÑÏÑù Ï°∞Í±¥:
- ÏÑ†ÌÉù Î∂ÑÏûê: {', '.join(params['selected_molecules'])}
- Ïò®ÎèÑ: {params['temperature']} K ({params['temperature']-273.15:.1f}¬∞C)
- ÏïïÎ†•: {params['pressure_torr']:.1f} torr ({params['pressure_atm']:.2f} atm)
- Í≤ΩÎ°ú Í∏∏Ïù¥: {params['path_length_m']:.0f} m ({params['path_length_km']:.1f} km)
- ÌååÏû• Î≤îÏúÑ: {params['wavelength_min']}-{params['wavelength_max']} nm

Î∂ÑÏûêÎ≥Ñ ÎÜçÎèÑ:
"""
            for molecule in params['selected_molecules']:
                conc_ppb = params['molecule_concentrations'].get(molecule, 0)
                summary_text += f"- {molecule}: {conc_ppb:.1f} ppb ({conc_ppb/1000:.3f} ppm)\n"
            
            summary_text += f"\nÏ¥ù ÎÜçÎèÑ: {sum(params['molecule_concentrations'].values()):.1f} ppb\n"
            
            summary_text += f"""
Î∂ÑÏÑù Í≤∞Í≥º:
- ÏµúÏÜå Ìà¨Í≥ºÏú®: {np.min(results['combined_transmittance']):.4f}
- ÏµúÎåÄ Ìù°Í¥ëÎèÑ: {np.max(results['combined_absorbance']):.4f}
- Ï¥ù HITRAN ÎùºÏù∏ Ïàò: {results['total_lines']:,}

Î∂ÑÏûêÎ≥Ñ Í∏∞Ïó¨ÎèÑ:
"""
            for data in results['contribution_data']:
                summary_text += f"- {data['Î∂ÑÏûê']}: ÏµúÎåÄ Ìù°Í¥ëÎèÑ {data['ÏµúÎåÄ Ìù°Í¥ëÎèÑ']}, Í∏∞Ïó¨Ïú® {data['Í∏∞Ïó¨Ïú®']}\n"
            
            st.download_button(
                label="üìã Î∂ÑÏÑù ÏöîÏïΩ (TXT)",
                data=summary_text,
                file_name=f"analysis_summary_{'-'.join(params['selected_molecules'])}_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.txt",
                mime="text/plain"
            )
        
        with col_download3:
            # Í∏∞Ïó¨ÎèÑ Îç∞Ïù¥ÌÑ∞ ÏóëÏÖÄ
            excel_buffer = io.BytesIO()
            with pd.ExcelWriter(excel_buffer, engine='openpyxl') as writer:
                # Í∏∞Î≥∏ Ï†ïÎ≥¥
                info_df = pd.DataFrame({
                    'Ìï≠Î™©': ['Ïò®ÎèÑ (K)', 'ÏïïÎ†• (torr)', 'Í≤ΩÎ°úÍ∏∏Ïù¥ (m)', 'ÌååÏû•Î≤îÏúÑ (nm)', 'Ï¥ùÎÜçÎèÑ (ppb)'],
                    'Í∞í': [params['temperature'], params['pressure_torr'], params['path_length_m'], f"{params['wavelength_min']}-{params['wavelength_max']}", sum(params['molecule_concentrations'].values())]
                })
                info_df.to_excel(writer, sheet_name='Î∂ÑÏÑùÏ°∞Í±¥', index=False)
                
                # Í∏∞Ïó¨ÎèÑ Îç∞Ïù¥ÌÑ∞
                df.to_excel(writer, sheet_name='Î∂ÑÏûêÎ≥ÑÍ∏∞Ïó¨ÎèÑ', index=False)
                
                # Ïä§ÌéôÌä∏Îüº Îç∞Ïù¥ÌÑ∞ (ÏÉòÌîåÎßÅ)
                sample_spectrum = spectrum_df.iloc[::10]
                sample_spectrum.to_excel(writer, sheet_name='Ïä§ÌéôÌä∏ÎüºÎç∞Ïù¥ÌÑ∞', index=False)
            
            excel_data = excel_buffer.getvalue()
            
            st.download_button(
                label="üìä Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ (Excel)",
                data=excel_data,
                file_name=f"crds_analysis_{'-'.join(params['selected_molecules'])}_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
        
        with col_download4:
            st.info("üñºÔ∏è Í∑∏ÎûòÌîÑ Ïù¥ÎØ∏ÏßÄÎäî Í∑∏ÎûòÌîÑ Ïö∞ÏÉÅÎã®Ïùò üì∑ Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Îã§Ïö¥Î°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§!")

# ÌïòÎã® Ï†ïÎ≥¥
st.markdown("---")
st.markdown("**Í∞úÎ∞ú:** HITRAN CRDS Simulator v2.1 (Session State + Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞) | **Îç∞Ïù¥ÌÑ∞:** HITRAN Database")
st.markdown("**ÏßÄÏõê Î∂ÑÏûê:** H2O, CO2, CH4, NH3, N2O, CO, O3, SO2, NO2, HNO3")